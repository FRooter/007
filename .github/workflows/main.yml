name: NTSC-Status

on:
  push:
    branches: master # Only trigger on master
    paths-ignore: # Don't trigger on files that are updated by the CI or other non-breaking files
    - 'tools/**'
    - '*.md'
    - '.github/**'
    - '.gitignore'
    - 'CppProperties.json'
    
  pull_request:
    branches: master # Only trigger on master
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  buildus:
    
    runs-on: ubuntu-18.04

    steps:
      - uses: actions/checkout@v2

      - name: Install Depedencies
        run: |
          sudo apt update
          sudo apt install binutils-mips-linux-gnu make
          wget https://github.com/n64decomp/qemu-irix/releases/download/v2.11-deb/qemu-irix-2.11.0-2169-g32ab296eef_amd64.deb
          sudo dpkg -i qemu-irix-2.11.0-2169-g32ab296eef_amd64.deb

      - name: Get precompiled recomp to save time
        env:
          IDO_RECOMP: ${{ secrets.FILE_RECOMP  }}
        run: |
          wget -O recomp.zip $IDO_RECOMP
          unzip -u recomp.zip -d tools/ido5.3_recomp

      - name: Get US File
        env:
          FILE_US: ${{ secrets.SECRET_FILE_US  }}
        run: wget -O baserom.u.z64 $FILE_US

      - name: Extract US Assets
        run: ./extract_baserom.u.sh
      
      - name: Make US 
        run: make -j IDO_RECOMP=YES VERSION=US
          
      - name: Make report
        run: make -C tools/report
        
      - name: Stats
        run: python3 tools/ge-stats.py --version us --report
        #git diff HEAD^ HEAD --name-only
            
        # expected args
        # 1481 15854 12774 232276 564 1312 652 20330 15471 269772 49 336 tools/report/index.html "src/game/bondview.c"
      
      # Replace this with Git push to repo
      # but somehow avoid loop
      
      #- uses: actions/download-artifact@v2
      #  with:
      #    name: my-artifact
      #    path: tools/report/index.html
      - name: Upload output files

        uses: dmnemec/copy_file_to_another_repo_action@v1.0.4

        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
          API_TOKEN_USER: ${{ secrets.API_TOKEN_USER }}
          API_TOKEN_EMAIL: ${{ secrets.API_TOKEN_EMAIL }}

        with:
          destination_repo: 'kholdfuzion/goldeneyestatus'
          user_email: $API_TOKEN_EMAIL
          user_name: $API_TOKEN_USER
          source_file: |
            tools/report/cursor.cur
            tools/report/index.html
            tools/report/sfx.ogg
            tools/report/background.jpg
      
#need way of telling report that JAP passed/failed
